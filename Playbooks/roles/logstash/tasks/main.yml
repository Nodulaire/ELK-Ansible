---
# This playbook contains logstash plays that will be run on all nodes

############## INSTALLATION ##############
- name      : Configure ufw rules
  ufw       : rule={{ item.rule }} port={{ item.port }}
  with_items:
    - { rule: 'allow', port: '{{ logstash_listenning_port }}' }
  notify:
    - restart ufw

#- name: super-ugly hack to allow unauthenticated packages to install
#  copy: content='APT::Get::AllowUnauthenticated "true";' dest=/etc/apt/apt.conf.d/99temp owner=root group=root mode=0644
  #https://github.com/ansible/ansible/issues/11620
- name : Installing logstash repo GPG Key
  apt_key: url=http://packages.elasticsearch.org/GPG-KEY-elasticsearch state=present

- name: adding repository
  apt_repository: repo="{{logstash_apt_repo_url}}" state=present update_cache=yes #allow_unauthenticated=true


- name: apt install
  apt: name=logstash state=present update_cache=true allow_unauthenticated=true
  ## INSTALLER AVEC DPKG
#- name: remove hack that allows unauthenticated packages to install
#  file: path=/etc/apt/apt.conf.d/99temp state=absent
############## configuration ##############
- name      : Add Logstash Conf
  copy      :
    src="{{  item.copies }}"
    dest="{{  logstash_etc_dir  }}/10-syslog.conf"
    #owner="{{ logstash_directory_owner }}"
    #group="{{ logstash_directory_group }}"
    #mode=0644
  with_items:
    - { copies: "{{logstash_src_conf_path}}/10-syslog.conf" }
  notify    :
    - validate configuration
    - restart initd
